<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AL_MINHDANG_ICHECK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <style>
        .image-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            display: block;
        }

    </style>
</head>
<body>
<div class="app-wrapper">
    <div class="history-sidebar">
        <div class="main-options">
            <div class="option-item" data-target-url="{{ url_for('trangchu_id') }}">
                <i class="fas fa-search"></i>
                <span>AI Tra cứu sơ bộ</span>
            </div>
            <div class="option-item" data-target-url="{{ url_for('index_id') }}">
                <i class="fas fa-book"></i>
                <span>AI Tra cứu thông tin</span>
            </div>
            <div class="option-item" data-target-url="{{ url_for('audio_id') }}">
                <i class="fas fa-phone-alt"></i>
                <span>AI Phân tích cuộc g...</span>
            </div>
            <div class="option-item" data-target-url="{{ url_for('chatbot_id') }}">
                <i class="fas fa-crosshairs"></i>
                <span>AI Roleplay, xử lý tì...</span>
            </div>
        </div>
        <h2>Lịch sử tìm kiếm</h2>
        <ul id="search-history-list" class="history-list">
        </ul>
    </div>


</div>

<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <p>Bạn có chắc chắn muốn xóa mục này không?</p>
        <div class="modal-buttons">
            <button class="confirm-btn" id="confirmDeleteBtn">Xóa</button>
            <button class="cancel-btn" id="cancelDeleteBtn">Hủy</button>
        </div>
    </div>
</div>

<script>
    const searchHistoryList = document.getElementById('search-history-list');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    let currentJobIdToDelete = null;

    const optionItems = document.querySelectorAll('.option-item');

    optionItems.forEach(item => {
        item.addEventListener('click', () => {
            const targetUrl = item.getAttribute('data-target-url');
            if (targetUrl) {
                window.location.href = targetUrl;
            }
        });
    });

    function setActiveOption() {
        const currentPath = window.location.pathname;
        optionItems.forEach(item => {
            const targetUrl = item.getAttribute('data-target-url');
            if (targetUrl) {
                if (currentPath === targetUrl || (targetUrl === '/' && currentPath === '/')) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', setActiveOption);

    async function loadSearchHistorySummary() {
        try {
            const response = await fetch('/history_summary');
            if (response.ok) {
                const historySummary = await response.json();
                searchHistoryList.innerHTML = '';
                if (historySummary.length === 0) {
                    searchHistoryList.innerHTML = '<li style="text-align: center; color: #888; padding: 10px;">Chưa có lịch sử nào.</li>';
                } else {
                    historySummary.forEach(item => {
                        addSearchHistoryItem(item);
                    });
                }
            } else {
                console.error('Không thể tải lịch sử tóm tắt:', response.statusText);
            }
        } catch (error) {
            console.error('Lỗi khi tải lịch sử tóm tắt:', error);
        }
    }

    function addSearchHistoryItem(item) {
        const listItem = document.createElement('li');
        listItem.classList.add('history-item');

        const link = document.createElement('a');
        link.href = '#';
        link.innerHTML = `<strong>${item.job_id}</strong> - ${item.source_file}`;
        link.onclick = async (e) => {
            e.preventDefault();
            window.location.href = `{{ url_for('audio_id') }}?job_id=${item.job_id}`;
        };

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('delete-btn');
        deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteButton.title = 'Xóa mục này';
        deleteButton.onclick = (e) => {
            e.stopPropagation();
            currentJobIdToDelete = item.job_id;
            deleteConfirmModal.style.display = 'flex';
        };

        listItem.appendChild(link);
        listItem.appendChild(deleteButton);
        searchHistoryList.appendChild(listItem);
    }

    async function handleDeleteJob(jobId) {
        try {
            const response = await fetch(`/delete/${jobId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                const result = await response.json();
                console.log(result.message || `Job ${jobId} đã được xóa thành công!`);
                await loadSearchHistorySummary();
            } else {
                const errorResult = await response.json();
                throw new Error(errorResult.detail || 'Lỗi không xác định khi xóa job.');
            }
        } catch (error) {
            console.error('Lỗi xóa job:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', loadSearchHistorySummary);

    confirmDeleteBtn.addEventListener('click', async () => {
        if (currentJobIdToDelete) {
            await handleDeleteJob(currentJobIdToDelete);
            currentJobIdToDelete = null;
        }
        deleteConfirmModal.style.display = 'none';
    });

    cancelDeleteBtn.addEventListener('click', () => {
        currentJobIdToDelete = null;
        deleteConfirmModal.style.display = 'none';
    });

    deleteConfirmModal.addEventListener('click', (e) => {
        if (e.target === deleteConfirmModal) {
            currentJobIdToDelete = null;
            deleteConfirmModal.style.display = 'none';
        }
    });
</script>
</body>
</html>